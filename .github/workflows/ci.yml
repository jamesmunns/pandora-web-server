name: CI

on:
  push:
    branches:
    - main
    - staging
    - ci
  pull_request: {}

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"

jobs:
  check:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        toolchain: [stable, beta, "1.74"]

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - name: Install toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
          toolchain: ${{ matrix.toolchain }}
          components: clippy
    - name: Clippy
      run: cargo clippy --workspace --all-targets --all-features
    - name: Build
      run: cargo build --workspace --all-targets --all-features
    - name: Run unit tests
      run: cargo test --workspace --all-targets --all-features
    - name: Run doc tests
      run: cargo test --workspace --doc --all-features

  format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
          toolchain: stable
          components: rustfmt
    - name: Formatting
      uses: actions-rust-lang/rustfmt@v1

  audit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Audit dependencies
      uses: actions-rust-lang/audit@v1
      with:
        denyWarnings: true
        # Several unmaintained dependencies in Pingora
        ignore: RUSTSEC-2021-0139,RUSTSEC-2024-0320,RUSTSEC-2021-0145

  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
          toolchain: stable
    - name: Build docs
      run: cargo doc --workspace --all-features --no-deps
